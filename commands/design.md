---
allowed-tools: TodoWrite, TodoRead, Read, Write, MultiEdit, mcp__serena__find_file, mcp__serena__find_symbol, mcp__serena__list_memories, mcp__serena__search_for_pattern
description: 要件に基づいた詳細設計仕様の作成（仕様駆動開発のステージ2）
---

## コンテキスト

- 要件定義書: @.tmp/requirements.md

## あなたのタスク

### 1. 前提条件の確認

- `.tmp/requirements.md`が存在することを確認
- 存在しない場合は、ユーザーに最初に`/requirements`を実行するよう通知

### 2. 要件の分析

**重要: 既存のファイルやコードを調査する際は、serenaを使用する必要があります。serenaを使用することで、トークン消費量を60-80%削減し、セマンティック検索機能を通じて必要な情報を効率的に取得できます。**

要件定義書を十分に読み、理解してください

### 3. 設計書の作成

以下のセクションで`.tmp/design.md`を作成:

````markdown
# 詳細設計書 - [タスク名]

## 1. アーキテクチャ概要

### 1.1 システム構成図

[ASCII図やMermaid図でシステム全体の構成を表現]

### 1.2 技術スタック

- 言語: [使用言語とバージョン]
- フレームワーク: [使用フレームワーク]
- ライブラリ: [主要ライブラリ一覧]
- ツール: [ビルドツール、テストツールなど]

## 2. コンポーネント設計

### 2.1 コンポーネント一覧

| コンポーネント名 | 責務         | 依存関係                 |
| ---------------- | ------------ | ------------------------ |
| [Component A]    | [責務の説明] | [依存するコンポーネント] |

### 2.2 各コンポーネントの詳細

#### [Component A]

- **目的**: [このコンポーネントの目的]
- **公開インターフェース**:
  ```typescript
  interface ComponentA {
    method1(param: Type): ReturnType;
  }
  ```
````

- **内部実装方針**: [実装のアプローチ]

## 3. データフロー

### 3.1 データフロー図

[データの流れを示す図]

### 3.2 データ変換

- 入力データ形式: [形式の説明]
- 処理過程: [変換ロジック]
- 出力データ形式: [形式の説明]

## 4. APIインターフェース

### 4.1 内部API

[モジュール間のインターフェース定義]

### 4.2 外部API

[外部システムとの連携インターフェース]

## 5. エラーハンドリング

### 5.1 エラー分類

- [エラータイプ1]: [対処方法]
- [エラータイプ2]: [対処方法]

### 5.2 エラー通知

[エラーの通知方法とログ戦略]

## 6. セキュリティ設計

### 6.1 認証・認可

[必要に応じて記載]

### 6.2 データ保護

[機密データの扱い方]

## 7. テスト設計

**詳細なテスト設計については、`/test-design`コマンドを実行してテスト設計書を作成してください。**

テスト設計書では以下の内容を定義します：

- 正常系・異常系・境界値テストケース
- テストデータ設計
- パフォーマンス・セキュリティテスト
- 自動化戦略

## 8. パフォーマンス最適化

### 8.1 想定される負荷

[パフォーマンス要件]

### 8.2 最適化方針

[最適化のアプローチ]

## 9. デプロイメント

### 9.1 デプロイ構成

[本番環境へのデプロイ方法]

### 9.2 設定管理

[環境変数、設定ファイルの管理]

## 10. 実装上の注意事項

- [注意点1]
- [注意点2]

```

### 4. TODOの更新
TodoWriteを使用して「詳細設計の完了とレビュー」をタスクとして追加

### 5. ユーザーへの提示
作成した設計書を表示し、以下を求める:
- 技術的フィードバック
- アーキテクチャの承認
- タスク分割への進行許可

## 重要注意事項
- 設計は実装可能でテスト可能であるべき
- 保守性と拡張性を考慮
- 可能な限り具体的なインターフェース定義を含める
- 要件定義書のすべての要件に対応
```

think hard
